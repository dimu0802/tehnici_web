{"version":3,"file":"index.js","sources":["../src/sharo.js"],"sourcesContent":["export var sharo_forgot_time = 3\r\nexport var sharo_debug = false\r\n\r\n\r\nexport class Blackboard {\r\n  constructor(nepnode, debug = false) {\r\n    this.topic = \"/blackboard\"\r\n    this.using_ros = false;\r\n    var roslib = \"\";\r\n    this.sharo_model = {}\r\n    sharo_debug = debug\r\n    console.log(\"Starting NEP communication\")\r\n    var sharo_model = this.sharo_model\r\n\r\n    // Proccess NEP Input\r\n    var NEPInput = function (msg) {\r\n      if (msg[\"primitive\"] in sharo_model) {\r\n        for (var key_i in msg[\"input\"]) {\r\n          try {\r\n            sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n            sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n            sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n          } catch (error) {\r\n            // console.log(\"New value: \" + input_[key_i])\r\n            // New value\r\n            sharo_model[msg[\"primitive\"]][key_i] = { \"value\": 0, \"time\": 0 }\r\n            sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n            sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n            sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n          }\r\n        }\r\n      }\r\n      else {\r\n        console.log(\"New primitive:\" + msg[\"primitive\"])\r\n        sharo_model[msg[\"primitive\"]] = {};\r\n        for (var key_i in msg[\"input\"]) {\r\n          try {\r\n            sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n            sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n            sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n          } catch (error) {\r\n            // console.log(\"New value: \" + input_[key_i])\r\n            // New value\r\n            sharo_model[msg[\"primitive\"]][key_i] = { \"value\": 0, \"time\": 0 }\r\n            sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n            sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n            sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    this.listener = nepnode.new_sub(this.topic, \"json\", NEPInput);\r\n    console.log(\"...\")\r\n  }\r\n\r\n\r\n  setInput(msg) {\r\n    if (msg[\"primitive\"] in this.sharo_model) {\r\n      for (var key_i in msg[\"input\"]) {\r\n        try {\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n        } catch (error) {\r\n          // console.log(\"New value: \" + input_[key_i])\r\n          // New value\r\n          this.sharo_model[msg[\"primitive\"]][key_i] = { \"value\": 0, \"time\": 0 }\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n        }\r\n      }\r\n    }\r\n    else {\r\n      console.log(\"New primitive:\" + msg[\"primitive\"])\r\n      this.sharo_model[msg[\"primitive\"]] = {};\r\n      for (var key_i in msg[\"input\"]) {\r\n        try {\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n        } catch (error) {\r\n          // console.log(\"New value: \" + input_[key_i])\r\n          // New value\r\n          this.sharo_model[msg[\"primitive\"]][key_i] = { \"value\": 0, \"time\": 0 }\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n          this.sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  useROS(ros_ip) {\r\n\r\n    var sharo_model = this.sharo_model\r\n    // Process ROS input\r\n    var ROSInput = function (message) {\r\n      var msg = {};\r\n      msg = JSON.parse(message.data)\r\n      if (msg[\"primitive\"] in sharo_model) {\r\n        for (var key_i in msg[\"input\"]) {\r\n          try {\r\n            sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n            sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n            sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n          } catch (error) {\r\n            // console.log(\"New value: \" + input_[key_i])\r\n            // New value\r\n            sharo_model[msg[\"primitive\"]][key_i] = { \"value\": 0, \"time\": 0 }\r\n            sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n            sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n            sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n          }\r\n        }\r\n      }\r\n      else {\r\n        console.log(\"New primitive:\" + msg[\"primitive\"])\r\n        sharo_model[msg[\"primitive\"]] = {};\r\n        for (var key_i in msg[\"input\"]) {\r\n          try {\r\n            sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n            sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n            sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n          } catch (error) {\r\n            // console.log(\"New value: \" + input_[key_i])\r\n            // New value\r\n            sharo_model[msg[\"primitive\"]][key_i] = { \"value\": 0, \"time\": 0 }\r\n            sharo_model[msg[\"primitive\"]][key_i][\"value\"] = msg[\"input\"][key_i]\r\n            sharo_model[msg[\"primitive\"]][key_i][\"time\"] = performance.now()\r\n            sharo_model[msg[\"primitive\"]][key_i][\"robot\"] = msg[\"robot\"]\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    if (this.using_ros === false) {\r\n      this.roslib = new ROSLIB.Ros({\r\n        url: 'ws://' + ros_ip + ':9090'\r\n      });\r\n\r\n      this.roslib.on('connection', function () {\r\n        console.log('Connected to websocket server.');\r\n      });\r\n\r\n      this.roslib.on('error', function (error) {\r\n        console.log('Error connecting to websocket server: ', error);\r\n      });\r\n\r\n      this.roslib.on('close', function () {\r\n        console.log('Connection to websocket server closed.');\r\n      });\r\n\r\n      var ros_listener = new ROSLIB.Topic({\r\n        ros: this.roslib,\r\n        name: this.topic,\r\n        messageType: 'std_msgs/String'\r\n      });\r\n      ros_listener.subscribe(ROSInput);\r\n      this.using_ros === true\r\n    }\r\n    else {\r\n      console.log(\"ros already started\")\r\n    }\r\n  }\r\n\r\n  resetBlackboard() {\r\n\r\n    var current_time = performance.now();\r\n    for (var key_m in this.sharo_model) {\r\n      for (var key in this.sharo_model[key_m]) {\r\n        this.sharo_model[key_m][key][\"time\"] = current_time\r\n      }\r\n    }\r\n    console.log(this.sharo_model)\r\n  }\r\n\r\n  getModel() {\r\n    return this.sharo_model\r\n  };\r\n}\r\n\r\n"],"names":["exports","Blackboard","nepnode","debug","topic","using_ros","sharo_model","sharo_debug","console","log","this","listener","new_sub","msg","key_i","performance","now","error","ros_ip","roslib","ROSLIB","Ros","url","on","Topic","ros","name","messageType","subscribe","message","JSON","parse","data","current_time","key_m","key"],"mappings":"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"}